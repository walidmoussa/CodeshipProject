{% if websocket_port %}
upstream websocket_{{ domain | replace('.', '_') }}{
  server 127.0.0.1:{{ websocket_port }};
}
{% endif %}

server {
  listen 80;
  listen [::]:80;
  server_name {{ domain }};

  root {{ ansistrano_deploy_to }}/current/public;
  index index.php index.html;
  error_page 404 /index.php;

  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-XSS-Protection "1; mode=block";
  add_header X-Content-Type-Options "nosniff";

  location / {
    try_files $uri $uri/ /index.php?query_string;
  }

  {% if websocket_port %}
  location /socket.io {
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_pass http://websocket_{{ domain | replace('.', '_') }};
  }
  {% endif %}

  {% if php_version %}
  location ~ \.php {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/var/run/php/php{{ php_version }}-fpm.sock;
  }
  {% endif %}

  location ~ /\.ht {
    deny all;
  }

  location ~ /\.(?!well-known).* {
    deny all;
  }

  location ~* \.(jpg|jpeg|gif|css|png|js|ico|html)$ {
    access_log off;
    expires max;
  }
}